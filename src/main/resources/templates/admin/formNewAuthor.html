<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Admin Home</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- CSS personalizzato -->
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
</head>

<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Messaggio di successo -->
      <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div class="card shadow-lg rounded-4 border-0">
        <div class="card-header bg-primary text-white rounded-top-4">
          <h4 class="mb-0">Aggiungi un nuovo autore</h4>
        </div>

        <div class="card-body p-4">
          <form id="autoreForm" th:action="@{/admin/addAuthor}" th:object="${author}" method="post" enctype="multipart/form-data">

            <!-- Foto autore -->
            <div class="mb-3">
              <label class="form-label">Foto autore</label>
              <input type="file" id="photo" name="photo" class="form-control" />
            </div>

            <!-- Anteprima immagine -->
            <div class="mb-3">
              <label class="form-label">Anteprima:</label>
              <div>
                <img id="photoPreview" src="#" alt="Anteprima immagine" class="img-thumbnail" style="display:none; max-width: 200px;">
              </div>
            </div>

            <!-- Nome -->
            <div class="mb-3">
              <label for="name" class="form-label">Nome</label>
              <input type="text" class="form-control" id="name" th:field="*{name}" required>
            </div>

            <!-- Cognome -->
            <div class="mb-3">
              <label for="surname" class="form-label">Cognome</label>
              <input type="text" class="form-control" id="surname" th:field="*{surname}" required>
            </div>

            <!-- Data di nascita -->
            <div class="mb-3">
              <label class="form-label">Data di nascita</label>
              <input type="date" class="form-control" th:field="*{dateOfBirth}" required>
              <div class="text-danger" th:if="${#fields.hasErrors('dateOfBirth')}" th:errors="*{dateOfBirth}"></div>
            </div>

            <!-- Data di morte -->
            <div class="mb-3">
              <label class="form-label">Data di morte (opzionale)</label>
              <input type="date" class="form-control" th:field="*{dateOfDeath}">
            </div>

            <!-- Libri scritti -->
            <div class="mb-3">
              <label class="form-label">Seleziona i libri scritti dall'autore</label>
              <input type="hidden" class="form-select" th:field="*{written}" id="books">

              <div class="dropdown mb-3">
                <button class="btn btn-secondary dropdown-toggle"
                        type="button"
                        id="bookDropdown"
                        data-bs-toggle="dropdown"
                        aria-expanded="false">
                  Seleziona un libro
                </button>
                <ul class="dropdown-menu" aria-labelledby="bookDropdown">
                  <li th:each="book : ${books}">
                    <a class="dropdown-item"
                       th:href="@{'/admin/formNewAuthor/addBook/' + ${book.id}}"
                       th:text="${book.title}"></a>
                  </li>
                  <li th:if="${#lists.isEmpty(books)}">
                    <span class="dropdown-item-text text-muted">Nessun libro disponibile</span>
                  </li>
                </ul>
              </div>

              <div th:each="writ : *{written}" th:text="${writ.title}">Libro selezionato</div>
            </div>

            <!-- Pulsante submit -->
            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">Salva Autore</button>
            </div>
          </form>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-secondary">Torna alla home</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Anteprima immagine -->
<script>
  document.getElementById('photo').addEventListener('change', function(event) {
    const input = event.target;
    const preview = document.getElementById('photoPreview');

    if (input.files && input.files[0]) {
      const file = input.files[0];
      const objectUrl = URL.createObjectURL(file);
      preview.src = objectUrl;
      preview.style.display = 'block';

      preview.onload = () => URL.revokeObjectURL(objectUrl);
    } else {
      preview.src = '#';
      preview.style.display = 'none';
    }
  });
</script>

<!-- Salvataggio in localStorage -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("autoreForm");

    if (!form) return;

    Array.from(form.elements).forEach(input => {
      if (!input.name || input.type === "file") return; // IGNORA input file

      const key = "form_" + input.name;
      const saved = localStorage.getItem(key);
      if (saved) {
        input.value = saved;
      }

      input.addEventListener("input", () => {
        localStorage.setItem(key, input.value);
      });
    });

    form.addEventListener("submit", function () {
      Array.from(form.elements).forEach(input => {
        if (input.name && input.type !== "file") {
          localStorage.removeItem("form_" + input.name);
        }
      });
    });
  });
</script>


</body>
</html>
