<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Admin Home</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- CSS personalizzato -->
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link rel="icon" type="image/x-icon" th:href="@{/favicon.ico}">
</head>

<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <!-- Success message -->
      <div th:if="${errors}" class="alert alert-error alert-dismissible fade show" role="alert">
        <span th:text="${errors}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div class="card shadow-lg rounded-4 border-0">
        <div class="card-header bg-primary text-white rounded-top-4">
          <h4 class="mb-0">Aggiungi un nuovo libro</h4>
        </div>
        <div class="card-body p-4">
          <form id="libroForm" th:action="@{/admin/addBook}" th:object="${book}" method="post" enctype="multipart/form-data">

            <div class="mb-3">
              <label class="form-label">Copertina del libro</label>
              <input type="file" id="photo" name="photo" class="form-control" />
            </div>

            <div class="mb-3">
              <label for="images" class="form-label">Altre immagini del libro</label>
              <input type="file" name="images" id="images" class="form-control" multiple>
            </div>

            <div class="mb-3">
              <label for="title" class="form-label">Titolo</label>
              <input type="text" class="form-control" id="title" th:field="*{title}" required>
            </div>

            <div class="mb-3">
              <label for="publicationYear" class="form-label">Anno di Pubblicazione</label>
              <input type="number" class="form-control" id="publicationYear" th:field="*{publicationYear}" min="0">
            </div>


            <!-- Autori -->
            <input type="hidden" name="authorIds" id="authorIds" />

            <!-- Dropdown per selezionare gli autori -->
            <div class="dropdown mb-3">
              <button class="btn btn-secondary dropdown-toggle" type="button" id="authorDropdown" data-bs-toggle="dropdown">
                Seleziona un Autore
              </button>
              <ul class="dropdown-menu" aria-labelledby="authorDropdown" id="authorList">
                <li th:each="author : ${authors}">
                  <a class="dropdown-item" href="#" th:attr="data-id=${author.id}" th:text="${author.name} + ' ' + ${author.surname}"></a>
                </li>
              </ul>
            </div>

            <!-- Visualizzazione degli autori selezionati -->
            <ul class="list-group mb-3" id="selectedAuthorList"></ul>


            <div class="d-grid">
              <button type="submit" class="btn btn-primary btn-lg">Salva Libro</button>
            </div>
          </form>
        </div>
      </div>

      <div class="text-center mt-4">
        <a href="/" class="btn btn-outline-secondary">Torna alla home</a>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Anteprima immagine -->
<script>
  document.getElementById('photo').addEventListener('change', function(event) {
    const input = event.target;
    const preview = document.getElementById('photoPreview');

    if (input.files && input.files[0]) {
      const file = input.files[0];
      const objectUrl = URL.createObjectURL(file);
      preview.src = objectUrl;
      preview.style.display = 'block';

      preview.onload = () => URL.revokeObjectURL(objectUrl);
    } else {
      preview.src = '#';
      preview.style.display = 'none';
    }
  });
</script>

<!-- Salvataggio in localStorage -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("libroForm");

    if (!form) return;

    Array.from(form.elements).forEach(input => {
      if (!input.name || input.type === "file") return; // IGNORA input file

      const key = "form_" + input.name;
      const saved = localStorage.getItem(key);
      if (saved) {
        input.value = saved;
      }

      input.addEventListener("input", () => {
        localStorage.setItem(key, input.value);
      });
    });

    form.addEventListener("submit", function () {
      Array.from(form.elements).forEach(input => {
        if (input.name && input.type !== "file") {
          localStorage.removeItem("form_" + input.name);
        }
      });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const authorList = document.getElementById("authorList");
    const selectedAuthorList = document.getElementById("selectedAuthorList");
    const authorIdsInput = document.getElementById("authorIds");

    const selectedAuthors = new Map(); // id -> titolo

    authorList.addEventListener("click", function (e) {
      e.preventDefault();
      const target = e.target;
      if (target && target.dataset.id) {
        const id = target.dataset.id;
        const name = target.textContent;

        if (!selectedAuthors.has(id)) {
          selectedAuthors.set(id, name);
          updateSelectedAuthors();

          // Rimuove il libro selezionato dal menu dropdown
          target.parentElement.remove();
        }
      }
    });

    function updateSelectedAuthors() {
      selectedAuthorList.innerHTML = "";
      selectedAuthors.forEach((name, id) => {
        const li = document.createElement("li");
        li.classList.add("list-group-item", "d-flex", "justify-content-between", "align-items-center");
        li.textContent = name;

        const removeBtn = document.createElement("button");
        removeBtn.classList.add("btn", "btn-sm", "btn-danger");
        removeBtn.textContent = "Rimuovi";
        removeBtn.onclick = () => {
          selectedAuthors.delete(id);
          updateSelectedAuthors();

          // Ricrea il menu item nel dropdown
          const liDropdown = document.createElement("li");
          const a = document.createElement("a");
          a.classList.add("dropdown-item");
          a.href = "#";
          a.dataset.id = id;
          a.textContent = name;
          liDropdown.appendChild(a);
          authorList.appendChild(liDropdown);
        };

        li.appendChild(removeBtn);
        selectedAuthorList.appendChild(li);
      });

      // Aggiorna lâ€™input nascosto con gli ID selezionati
      authorIdsInput.value = Array.from(selectedAuthors.keys()).join(",");
    }
  });
</script>


</body>
</html>
